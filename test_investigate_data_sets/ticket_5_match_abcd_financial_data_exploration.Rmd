---
title: "ticket_5_match abcd_financial_dara exploration"
output: github_document
date: "2023-03-02"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages, echo=FALSE, message=FALSE}
devtools::load_all()
```

```{r load financial data, echo=FALSE}
financial_data_path <- r2dii.utils::path_dropbox_2dii("ST_INPUTS", "ST_INPUTS_MASTER", "prewrangled_financial_data_stress_test.csv")

financial_data <- read.csv(financial_data_path)
```

```{r load stress test abcd data, echo=FALSE}
abcd_full_path <- r2dii.utils::path_dropbox_2dii("ST_INPUTS", "ST_INPUTS_MASTER", "abcd_stress_test_input.csv")

abcd_full <- read.csv(abcd_full_path)
```

#1.Count uniqe company_name in abcd_stress_test (42 500)
```{r filter company names abcd, echo=FALSE}
abcd_full_names <- abcd_full %>% dplyr::select(company_name) %>% unique()
dim(abcd_full_names)
```

#2.Count uniqe company_name in financial_data (50 492)
```{r filter company names, echo=FALSE}
financial_data_names <- financial_data %>% dplyr::select(company_name) %>% unique()
dim(financial_data_names)
```

#3.Match on company names (12859)
```{r match company names and show dim, echo=FALSE}
unproblematic <- dplyr::inner_join(abcd_full_names,financial_data_names, by = "company_name")

dim(unproblematic)
```

#4. matching  over id (and keep company name) (27715)
```{r match id and show dim, echo=FALSE}
abcd_full_id <- abcd_full %>% dplyr::select(c(id, company_name)) %>% unique()

financial_data_id <- financial_data %>% dplyr::select(c(company_id, company_name)) %>% unique() %>% dplyr::rename(id = company_id)

unproblematic_id <- dplyr::inner_join(abcd_full_id,financial_data_id, by = "id") %>% 
  dplyr::rename(company_name = company_name.x)

unproblematic_id_final <- unproblematic_id %>% dplyr::select(id)

#write.csv(unproblematic_id_final,"/Users/2diigermanylpt-08/Desktop/unproblematic_id_final.csv", row.names = FALSE)

dim(unproblematic_id_final)
```

#5. full trajectory is the df that is genereated in the stress test when production data and financial data are matched 
```{r read in full trajectory before that is when it is matched on id and company name, echo=FALSE, message=FALSE}
input_full_trajectory_path <- r2dii.utils::path_dropbox_2dii(
  "PortCheck",
  "00_Data",
  "07_AnalysisInputs",
  "production_financial_data_matching",
  "full_trajectory.csv"
)

full_trajectory <- readr::read_csv(input_full_trajectory_path)
```

#6. count full trajectory company names (11 500)
```{r count number of company names in the full trajectory, echo=FALSE}
full_trajectory_names <- full_trajectory %>% dplyr::select(company_name) %>% unique()
dim(full_trajectory_names)
```

```{r why is it the case that full_trajectory names is smaller than unproblematic, echo= FALSE, eval =FALSE}
test <- dplyr::anti_join(unproblematic, full_trajectory_names, by = "company_name")

# Automotive sector companies make bc full_trajectory looks at global and weo data 
# plan prod is zero at times and gets thus removed 
```

#7. full trajectory after is the df that is genereated in the stress test when production data and financial data are matched only on id
```{r read in full trajectory when its matched only on id, echo=FALSE, message=FALSE}
input_full_trajectory_after_path <- r2dii.utils::path_dropbox_2dii(
  "PortCheck",
  "00_Data",
  "07_AnalysisInputs",
  "production_financial_data_matching",
  "full_trajectory_new.csv"
)

full_trajectory_after <- readr::read_csv(input_full_trajectory_after_path)
```

#8. count full trajectory after company names (25055)
```{r match and show dim of full trajectory after names, echo=FALSE}
full_trajectory_after_names <-  full_trajectory_after %>% dplyr::select(company_name) %>% unique()

dim(full_trajectory_after_names)
```

```{r hy is it the case that full_trajectory after names is smaller than unproblematic_id, echo=FALSE, eval =FALSE}
test_2 <- dplyr::anti_join(unproblematic_id, full_trajectory_after_names)

#same reasons as stated in the above
```

##RESULTS
* matching over ids instead of company_name and id increases coverage to 27715 
* lets see now what the result would be using the tilt matcher 


```{r read in the relevant libary, echo=FALSE, message=FALSE}
library(tilt.company.match)
```

```{r reduce the data sets to the relevant variables, echo=FALSE}
abcd_reduced <- abcd_full %>% dplyr::select(c(company_name, id)) %>% unique()

financial_data_reduced <- financial_data %>% dplyr::select(c(company_name, company_id)) %>% unique()
```

```{r in this step financial data id column is aligned it throws an error if variables carry different names}
crucial_names <- c("id", "company_name")

financial_data_reduced <- financial_data_reduced %>%
  dplyr::rename(
    "id" = "company_id"
  )

check_crucial_names(financial_data_reduced, crucial_names)
report_duplicates(financial_data_reduced, crucial_names)
```

```{r in this step company_alias is created for both datasets}
financial_data_reduced <- financial_data_reduced %>%
  dplyr::mutate(company_alias = to_alias(company_name))

knitr::kable(head(financial_data_reduced))

abcd_reduced <- abcd_reduced %>%
  dplyr::mutate(company_alias = to_alias(company_name))

knitr::kable(head(abcd_reduced))
```

#9. matching over company_id: 27715 companies 

```{r matching financial and production data on id}
loanbook_with_candidates <- financial_data_reduced %>%
  dplyr::inner_join(abcd_reduced, by = c("id"), suffix = c("", "_abcd"))

# i get less candidates if i try to match over company_alias 25085
#loanbook_with_candidates <- financial_data_reduced %>%
#dplyr::inner_join(abcd_reduced, by = c("company_alias"), suffix = c("", "_abcd"))
```

```{r this introduces distance measure between the company aliases}
loanbook_with_candidates_and_dist <- loanbook_with_candidates %>%
  dplyr::mutate(string_sim = stringdist::stringsim(a = .data$company_alias, b = .data$company_alias_abcd, method = "jw", p = 0.1)) %>%
  dplyr::arrange(id, -string_sim)

#knitr::kable(loanbook_with_candidates_and_dist)
```


#10: filtering out some companies which are under the threshold: 27153 
```{r set the threshold and filter accordingly, echo = FALSE}
min_threshold <- 0.75

loanbook_with_candidates_and_dist_filtered <- loanbook_with_candidates_and_dist %>% 
  dplyr::filter(is.na(string_sim) | string_sim > min_threshold)

```

#11: these lost companies are: 562 
```{r this shows what company names are cut off}
before_filter_id_and_company <- loanbook_with_candidates_and_dist %>% 
  dplyr::select(id, company_name) %>% 
  dplyr::distinct_all()

after_filter_id_and_company <- loanbook_with_candidates_and_dist_filtered %>% 
  dplyr::select(id, company_name) %>% 
  dplyr::distinct_all()

lost_companies <- before_filter_id_and_company %>% 
  dplyr::anti_join(after_filter_id_and_company)

#knitr::kable(lost_companies)
```

```{r final dataframe}
highest_matches_per_company <- loanbook_with_candidates_and_dist_filtered %>%
  dplyr::group_by(id) %>%
  dplyr::filter(string_sim == max(string_sim))

threshold <- 0.9 # Threshold decided upon extensive experience with r2dii.match function and processes

highest_matches_per_company_above_thresh <- highest_matches_per_company %>%
  dplyr::filter(string_sim > threshold)

highest_matches_per_company_above_thresh_wo_duplicates <- highest_matches_per_company_above_thresh %>%
  dplyr::mutate(duplicates = any(duplicated(company_name))) %>%
  dplyr::filter(duplicates == FALSE) %>%
  dplyr::select(id) %>%
  dplyr::mutate(suggest_match = TRUE)

loanbook_with_candidates_and_dist_and_suggestion <- loanbook_with_candidates_and_dist_filtered %>%
  dplyr::left_join(highest_matches_per_company_above_thresh_wo_duplicates, by = c("id")) %>%
  dplyr::mutate(accept_match = NA)

#knitr::kable(loanbook_with_candidates_and_dist_and_suggestion)
```
