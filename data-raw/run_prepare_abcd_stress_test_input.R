# This script generates the abcd input from asset_resolution data
# as well as the production_type.rda reference dataset in this packge
# TODO all the code before abcd_data should be translated to SQL

devtools::load_all()

## PARAMETERS
path_ar_data_raw <-
  r2dii.utils::path_dropbox_2dii(
    "ST_INPUTS",
    "ST_INPUTS_PRODUCTION"
  )

output_path_stress_test_input <-
  r2dii.utils::path_dropbox_2dii(
    "ST_INPUTS",
    "ST_INPUTS_MASTER"
  ) 

start_year <- 2022
time_horizon <- 5
additional_year <- NULL
sector_list <- c("Automotive", "Power", "Oil&Gas", "Coal")
km_per_vehicle <- 15000

bench_regions <-
  readr::read_rds(here::here("data-raw", "bench_regions.rds"))


#' read Asset Resolution data
#'
#' @param path_ar_data_raw path to AR excel input
#'
#' @param sheet_name name of excel sheet
#'
read_asset_resolution <- function(path_ar_data_raw, sheet_name) {
  ar_data <- readxl::read_xlsx(path_ar_data_raw,
    sheet = sheet_name
  ) |>
    dplyr::select(-dplyr::starts_with("Direct Ownership")) |>
    dplyr::rename(
      id = .data$`Company ID`,
      company_name = .data$`Company Name`,
      ald_sector = .data$`Asset Sector`,
      technology = .data$`Asset Technology`,
      technology_type = .data$`Asset Technology Type`,
      region = .data$`Asset Region`,
      ald_location = .data$`Asset Country`,
      activity_unit = .data$`Activity Unit`
    )
  return(ar_data)
}


company_activities <-
  read_asset_resolution(
    fs::path(path_ar_data_raw,
      "AR-Company-Indicators_2022Q4",
      ext = "xlsx"
    )
)
company_activities <- outputs[["company_activities"]]
company_emissions <- outputs[["company_emissions"]]

# THE PART ABOVE IS ASSET RESOLUTION SPECIFIC
# ========================
# CONVERT CLEAN COMPANY DATA TO ABCD BELOW

abcd_stress_test_input <-
  prepare_abcd_data(
    company_activities = company_activities,
    company_emissions = company_emissions,
    scenarios_geographies = scenarios_geographies, # loaded from package
    start_year = start_year,
    time_horizon = time_horizon,
    additional_year = additional_year,
    km_per_vehicle = km_per_vehicle,
    sector_list = sector_list
  )

abcd_stress_test_input %>% 
  assertr::verify(all(colSums(is.na(.)) == 0))

abcd_stress_test_input %>% readr::write_csv(fs::path(
  output_path_stress_test_input,
  "abcd_stress_test_input",
  ext = "csv"
))
